name: Lighthouse Audit

on:
  # Run after every successful deploy
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types: [completed]
  # Allow manual runs
  workflow_dispatch:

permissions:
  contents: write
  # Needed to post commit status checks
  statuses: write

jobs:
  audit:
    # Only run if the deploy actually succeeded (skip on failure)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for deploy propagation
        run: sleep 30

      - name: Run Lighthouse CI
        id: lhci
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: ./lighthouserc.cjs
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract scores to content/lighthouse.json
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Lighthouse CI writes .lighthouseci/*.json for each run
            const lhciDir = '.lighthouseci';
            if (!fs.existsSync(lhciDir)) {
              console.log('No .lighthouseci directory found — skipping score extraction');
              return;
            }

            const files = fs.readdirSync(lhciDir).filter(f => f.startsWith('lhr-') && f.endsWith('.json'));
            if (files.length === 0) {
              console.log('No Lighthouse result files found');
              return;
            }

            // Group results by URL — each URL may have multiple runs (numberOfRuns)
            const byUrl = {};
            for (const file of files) {
              const raw = fs.readFileSync(path.join(lhciDir, file), 'utf-8');
              const lhr = JSON.parse(raw);
              const url = lhr.finalUrl || lhr.requestedUrl;
              if (!byUrl[url]) byUrl[url] = [];
              byUrl[url].push(lhr);
            }

            // For each URL, pick the median run by performance score
            const pages = [];
            for (const [url, runs] of Object.entries(byUrl)) {
              // Sort by performance score, pick the median
              const sorted = runs.sort((a, b) =>
                (a.categories?.performance?.score ?? 0) - (b.categories?.performance?.score ?? 0)
              );
              const median = sorted[Math.floor(sorted.length / 2)];

              const categories = median.categories || {};
              pages.push({
                url: url.replace('https://chadmoore.info', ''),
                scores: {
                  performance: Math.round((categories.performance?.score ?? 0) * 100),
                  accessibility: Math.round((categories.accessibility?.score ?? 0) * 100),
                  bestPractices: Math.round((categories['best-practices']?.score ?? 0) * 100),
                  seo: Math.round((categories.seo?.score ?? 0) * 100),
                },
              });
            }

            // Sort pages by URL for stable output
            pages.sort((a, b) => a.url.localeCompare(b.url));

            const result = {
              timestamp: new Date().toISOString(),
              pages,
            };

            // Parse links output from treosh action (JSON array of report URLs)
            const linksRaw = `${{ steps.lhci.outputs.links }}`;
            try {
              const links = JSON.parse(linksRaw);
              if (typeof links === 'object' && links !== null) {
                result.reportLinks = links;
              }
            } catch {
              // links output may not always be valid JSON
            }

            fs.writeFileSync(
              'content/lighthouse.json',
              JSON.stringify(result, null, 2) + '\n'
            );
            console.log(`Wrote lighthouse.json with ${pages.length} page(s)`);

      - name: Commit lighthouse results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/lighthouse.json
          if git diff --cached --quiet; then
            echo "No changes to lighthouse.json"
          else
            git commit -m "chore: update lighthouse scores [skip ci]"
            git push
          fi
